# DateBase

## 事务

### 特征 (ACID)

1. 原子性(Atomicity)  
    事务中的操作要么全部发生, 要么全部都不发生

2. 一致性(Consistency)
    事务执行前后, 数据的完整性保持一致 且 事务执行前后数据的总和不变

3. 隔离性(Isolation)

    1. 一个事务的执行不能被其他事务干扰, 即一个事务内部的操作 及 使用的数据 对并发的其他事务是 隔离的, 并发执行的各个事务之间不能互相干扰

    2. 两个事务之间是没有交集的

    3. 隔离性与隔离级别是有关的

4. 持久性(Durability)
    事务一旦提交, 对数据库中数据的改变就是永久性的, 直到其他事务将该数据发生修改

### 并发 4 问题

1. 脏写
    多个事务并发写入同一数据时, 先执行的事务所写数据 被后写的数据覆盖

2. 脏读
    一个事务 写入数据 且 未提交/终止, 另一事务便读取到了 写入的数据

3. 不可重复读
    一个事务 对同一数据项进行多次读取, 但是在两次读取间 另一事务修改了该数据项 并 进行了提交, 则 后一次读取到修改, 导致两次读取 信息不一致

4. 幻读
    一个事务 进行两次统计, 但是在两次统计期间 另一事务 添加了新的数据项 并且进行了提交, 则 后一次统计到修改, 导致两次统计信息不一致

### 隔离性

![](https://xiao060.oss-cn-hangzhou.aliyuncs.com/md/202310162058411.png)

```mysql
-- 1. 查看 隔离性
SELECT @@transaction_isolation;

-- 2. 设置 会话/全局 隔离性
SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED;

```

1. read uncommitted

2. read committed

3. repeatable read

    ![](https://xiao060.oss-cn-hangzhou.aliyuncs.com/md/202310162324243.png)

    ![](https://xiao060.oss-cn-hangzhou.aliyuncs.com/md/202310162341555.png)

4. serializable

    ![](https://xiao060.oss-cn-hangzhou.aliyuncs.com/md/202310162349033.png)

## 索引

### B 树

1. 多叉树, 每个大节点中可以存放多条数据(小节点), 每个小节点会存储 索引信息/数据信息/指向下一个节点的指针, 相比于 二叉树, 可以降低树的高度, 进而较低磁盘 IO 的次数, 减少时间消耗;

2. 但是 因为 每个而小节点还需要存放数据信息, 导致 每个大节点中存放的小节点个数有限

### B+ 树

1. 除叶节点外每个节点只会存储 索引/指向下一个节点的指针, 相比于 B 树, 每个大节点中存放的小节点个数更多, 树的高度会更低, IO 次数更少;

2. 所有的 叶子节点 存储完整的一份 索引信息(Key) 以及 对应的data信息;

3. 每一个父节点 都出现在子节点中, 是子节点的最大或者最小的元素;

4. 每个叶子节点都有一个指针, 指向下一个节点, 形成一个链表

### 最左前缀

1. 建立组合索引时, 放在前面的列是建立索引首先需要参考的排序标准; 

2. 在进行组合索引的查询时, 一定要出现最左边的列, 而不能直接跳过最左边的列, 否则用不到索引就只能进行全表扫描(遍历)

## 存储引擎

### MyISAM

#### 特点

1. 查询速度很快
2. 支持表锁
3. 支持全文索引 (正排索引/倒排索引)
4. 不支持事务

#### 存储形式

生成三个文件

1. .frm 存储表结构
2. .myd 存放数据
3. .myi 存放索引

### InnoDB

#### 特点

1. 支持事务
2. 支持行锁和表锁 (默认支持行锁)
3. 支持MVCC (多版本并发控制)
4. 支持崩溃恢复
5. 支持外键一致性约束

#### 存储形式上

会生成两个文件

1. .frm 存储表结构
2. .ibd 存放数据和索引

### Memory

#### 特点

1. 所有数据都存放在内存中,因此数据库重启后会丢失
2. 支持表锁
3. 支持Hash和BTree索引
4. 不支持Blob(大的二进制)和Text(大的文本)字段

#### 与 临时表区别

1. 创建的方法

    1. 创建存储引擎是memory的表
        `create table test1 (id int, age int ,name varchar(20), primary key(id))ENGINE=memory;`

    2. 创建临时表
        `create temporary table test2 (id int, age int ,name varchar(20), primary key(id));`

2. 存储引擎
    临时表的存储引擎使用的是默认的,也就是innodb;而存储引擎是memory的表,存储引擎是memory

3. show tables
    执行show tables的时候,临时表是看不到表的名字的,但是存储引擎是memory的表可以看到表名

4. 基本的SQL操作
    临时表与存储引擎是memory的表都可以进行正常的SQL操作,包括:select、insert、delete、update

5. 关闭会话
    临时表只会存在当前会话,会话关闭之后,表名不存在、表的结构不存在、表的内容也不存在。
    但是存储引擎是memory的表,会话关闭之后,表的名字、结构、内容都是存在的。

6. 断电重启之后
    临时表断电重启之后,表名不存在、表的结构不存在、表的内容也不存在
    但是存储引擎是memory的表,断电重启后,表的名字、结构是存在的,但是表的内容不存在

## 索引

### 分类

1. 聚集索引
    将数据与索引合在一起存放。例如:InnoDB存储引擎。.idb

    1. 主键索引
        以主键创建的索引, 叶子节点存放的是 主键 与 本条数据除主键外的其他列信息

    2. 非主键索引(辅助索引)
        以非主键创建的索引。包括: <mark>唯一索引、普通索引、组合索引</mark>, 叶子节点存放的是 索引 与 以及对应的主键

        InnoDB存储引擎 使用 辅助索引 进行查询
        1. 如果查询的列在辅助索引树上都可以命中, 将这种情况称为索引覆盖(覆盖索引);
        2. 如果要查询的列在辅助索引树上没有命中, 会在辅助索引树的叶子结点下找到对应的主键, 然后使用主键在主键索引树上找其他的列, 这种情况称为 <mark>回表</mark>

2. 非聚集索引
    将数据与索引分开存在。例如:MyISAM存储引擎。.myd .myi
    叶子节点存放的是 索引 与 地址信息

    1. 主键索引
        以主键创建的索引, 叶子节点存储 主键 与 该列的地址信息

    2. 非主键索引(辅助索引)
        以非主键创建的索引。包括:<mark>唯一索引、普通索引、组合索引</mark>, 子节点存储 主键 与 该列的地址信息

### 原则

1. 选择经常用于查询条件的列作为索引列

2. 尽量选择较短的数据类型作为索引，以减少索引的存储空间和提高查询效率。

3. 对于经常同时出现在查询条件中的多个列，可以创建复合索引

4. 如果查询只需要从索引中获取数据，而不需要访问数据行，可以创建覆盖索引

5. 避免创建过多的冗余索引，只创建必要的索引来支持常见的查询和业务需求

6. 若是不能有效区分数据的列不适合做索引列 (如性别，男女未知，最多也就三种，区分度实在太低)
